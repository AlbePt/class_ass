{% extends "base.html" %}
{% block title %} ‚Äî –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä{% endblock %}
{% block content %}
<div class="space-y-8">
    <section class="rounded-3xl bg-white/90 p-8 shadow-xl shadow-indigo-100 ring-1 ring-indigo-100">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">
                    <span class="h-2 w-2 rounded-full bg-indigo-500 animate-pulse"></span>
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞
                </span>
                <h1 class="text-3xl font-semibold text-slate-900">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º</h1>
                <p class="max-w-2xl text-sm text-slate-500">–ú—ã —Å–æ–±—Ä–∞–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —É—á–µ–Ω–∏–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –≥—Ä—É–ø–ø–µ —Ä–∏—Å–∫–∞, –∞ –∑–∞—Ç–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç –≤ –ø–µ—á–∞—Ç–Ω–æ–º –∏–ª–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–º –≤–∏–¥–µ.</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <a id="downloadPdf" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition hover:bg-emerald-600" href="#">
                    üìÑ PDF
                </a>
                <a id="downloadXlsx" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-200 transition hover:bg-indigo-700" href="#">
                    üìä Excel
                </a>
                <button id="discardSession" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-5 py-3 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-rose-200 hover:text-rose-600">
                    –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é
                </button>
            </div>
        </div>
        <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4" id="summaryCards">
            <div class="summary-card">
                <p class="summary-label">–£—á–µ–Ω–∏–∫–∏</p>
                <p id="summaryTotal" class="summary-value">‚Äî</p>
            </div>
            <div class="summary-card">
                <p class="summary-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –≤—ã–±–æ—Ä–∫–µ</p>
                <p id="summaryAverage" class="summary-value">‚Äî</p>
            </div>
            <div class="summary-card">
                <p class="summary-label">–ï—Å—Ç—å —Å–ª–∞–±—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</p>
                <p id="summaryWeak" class="summary-value">‚Äî</p>
            </div>
            <div class="summary-card">
                <p class="summary-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</p>
                <p id="summaryWarnings" class="summary-value">‚Äî</p>
            </div>
        </div>
    </section>

    <section class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-200 ring-1 ring-slate-200/60">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="flex flex-wrap gap-3 text-sm text-slate-500">
                <label class="relative flex items-center">
                    <span class="sr-only">–ü–æ–∏—Å–∫ –ø–æ —É—á–µ–Ω–∏–∫–∞–º</span>
                    <span class="pointer-events-none absolute left-4 text-slate-400">üîç</span>
                    <input id="studentSearch" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏ –∏–ª–∏ –∫–ª–∞—Å—Å—É" class="w-72 rounded-full border border-slate-200 bg-slate-50 px-10 py-2 text-sm text-slate-700 shadow-inner focus:border-indigo-300 focus:outline-none focus:ring" autocomplete="off">
                </label>
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                    <input id="weakFilter" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                    –¢–æ–ª—å–∫–æ —Å–æ —Å–ª–∞–±—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
                </label>
            </div>
            <p id="lastUpdated" class="text-xs uppercase tracking-wide text-slate-400"></p>
        </div>
        <div id="warnings" class="mt-6"></div>
        <div id="previewLoader" class="mt-6 flex items-center gap-3 rounded-2xl bg-indigo-50 px-4 py-3 text-sm text-indigo-600">
            <span class="inline-flex h-2 w-2 animate-ping rounded-full bg-indigo-400"></span>
            –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞‚Ä¶
        </div>
        <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                        <tr>
                            <th class="px-4 py-3">–£—á–µ–Ω–∏–∫</th>
                            <th class="px-4 py-3">–ö–ª–∞—Å—Å</th>
                            <th class="px-4 py-3">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</th>
                            <th class="px-4 py-3">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                            <th class="px-4 py-3">–°–ª–∞–±—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</th>
                            <th class="px-4 py-3">–°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–º–µ—Ç–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody id="studentsBody" class="divide-y divide-slate-200 bg-white"></tbody>
                </table>
            </div>
        </div>
        <div id="emptyState" class="mt-6 hidden rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-6 py-8 text-center text-sm text-slate-500">
            –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é –≤—ã–≥—Ä—É–∑–∫—É.
        </div>
    </section>
</div>
<script>
    const session = '{{ session }}';
    const pdfLink = document.getElementById('downloadPdf');
    const xlsxLink = document.getElementById('downloadXlsx');
    const warningsEl = document.getElementById('warnings');
    const studentsBody = document.getElementById('studentsBody');
    const discardSession = document.getElementById('discardSession');
    const studentSearch = document.getElementById('studentSearch');
    const weakFilter = document.getElementById('weakFilter');
    const summaryTotal = document.getElementById('summaryTotal');
    const summaryAverage = document.getElementById('summaryAverage');
    const summaryWeak = document.getElementById('summaryWeak');
    const summaryWarnings = document.getElementById('summaryWarnings');
    const loader = document.getElementById('previewLoader');
    const emptyState = document.getElementById('emptyState');
    const lastUpdated = document.getElementById('lastUpdated');

    pdfLink.href = `/reports/current/export/pdf?session=${session}`;
    xlsxLink.href = `/reports/current/export/xlsx?session=${session}`;

    let students = [];

    function renderWarnings(dataWarnings = [], studentWarnings = []) {
        const allWarnings = [...dataWarnings, ...studentWarnings];
        if (!allWarnings.length) {
            warningsEl.innerHTML = '';
            return;
        }
        warningsEl.innerHTML = `
            <div class="rounded-2xl border border-amber-200 bg-amber-50 px-5 py-4 text-sm text-amber-800 shadow-sm">
                <p class="font-semibold">–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:</p>
                <ul class="mt-2 list-disc space-y-1 pl-5">
                    ${allWarnings.map((w) => `<li>${w}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    function renderStudents(list) {
        if (!list.length) {
            studentsBody.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        emptyState.classList.add('hidden');
        studentsBody.innerHTML = list.map((student, index) => {
            const weak = student.has_weak_subjects && student.weak_subjects.length
                ? student.weak_subjects.map((subject) => `<span class="weak-pill">${subject}</span>`).join(' ')
                : '<span class="text-slate-400">–ù–µ—Ç —Å–ª–∞–±—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</span>';
            const warningsMarkup = student.warnings.length
                ? student.warnings.map((warning) => `<span class="warning-pill">${warning}</span>`).join(' ')
                : '<span class="text-slate-400">‚Äî</span>';
            const average = student.average_score !== null ? student.average_score.toFixed(1) : '‚Äî';
            const zebra = index % 2 === 1 ? 'bg-slate-50/60' : '';
            return `
                <tr class="${zebra}">
                    <td class="px-4 py-3 text-slate-700">${student.fio}</td>
                    <td class="px-4 py-3 text-slate-500">${student.klass || '‚Äî'}</td>
                    <td class="px-4 py-3 text-slate-500">${student.subject_count}</td>
                    <td class="px-4 py-3 font-semibold text-slate-700">${average}</td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-2">${weak}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-2">${warningsMarkup}</div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateSummary(data) {
        const total = data.students.length;
        const weakCount = data.students.filter((student) => student.has_weak_subjects).length;
        const averages = data.students.map((student) => student.average_score).filter((value) => value !== null && !Number.isNaN(value));
        const avgValue = averages.length ? (averages.reduce((acc, value) => acc + value, 0) / averages.length).toFixed(1) : '‚Äî';
        const warningsTotal = (data.warnings || []).length + data.students.reduce((acc, student) => acc + (student.warnings || []).length, 0);

        summaryTotal.textContent = total || '‚Äî';
        summaryAverage.textContent = avgValue;
        summaryWeak.textContent = weakCount || '‚Äî';
        summaryWarnings.textContent = warningsTotal || '‚Äî';
        lastUpdated.textContent = `–°–µ—Å—Å–∏—è ${session.slice(0, 8)} ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${new Date().toLocaleString('ru-RU')}`;
    }

    function applyFilters() {
        const query = studentSearch.value.trim().toLowerCase();
        const onlyWeak = weakFilter.checked;
        const filtered = students.filter((student) => {
            const matchesQuery = !query || student.fio.toLowerCase().includes(query) || (student.klass || '').toLowerCase().includes(query);
            const matchesWeak = !onlyWeak || student.has_weak_subjects;
            return matchesQuery && matchesWeak;
        });
        renderStudents(filtered);
    }

    async function loadPreview() {
        try {
            const response = await fetch(`/reports/current/preview?session=${session}`);
            loader.classList.add('hidden');
            if (!response.ok) {
                warningsEl.innerHTML = '<div class="rounded-2xl border border-rose-200 bg-rose-50 px-5 py-4 text-sm text-rose-700">–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ.</div>';
                emptyState.classList.remove('hidden');
                return;
            }
            const data = await response.json();
            students = data.students || [];
            renderWarnings(data.warnings || []);
            renderStudents(students);
            updateSummary(data);
        } catch (error) {
            loader.classList.add('hidden');
            warningsEl.innerHTML = '<div class="rounded-2xl border border-rose-200 bg-rose-50 px-5 py-4 text-sm text-rose-700">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>';
        }
    }

    studentSearch.addEventListener('input', applyFilters);
    weakFilter.addEventListener('change', applyFilters);

    discardSession.addEventListener('click', async () => {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞?')) {
            return;
        }
        await fetch(`/reports/current/discard?session=${session}`, {
            method: 'POST'
        });
        window.location.href = '/reports/current/ui';
    });

    loadPreview();
</script>
{% endblock %}
